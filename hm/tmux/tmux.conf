#----------#
# Bindings #
#----------#

# Reload config
bind-key r source-file ~/.config/tmux/tmux.conf

# creating windows and panes
bind -n M-g split-window -h
bind -n M-c split-window -v
bind -n M-b new-window

# Fullscreen / zoom
bind -n M-f run-shell "sh -c 'tmux resize-pane -Z && tmux display-message -p #W | grep -q nvim && tmux send-keys C-w =' || true"

# Window switching (relative)
bind -n M-, switch-client -p
bind -n M-. switch-client -n
bind -n M-m previous-window
bind -n M-/ previous-window

# Window switching (by index)
set -g base-index 1
bind -n M-a selectw -t 1
bind -n M-r selectw -t 2
bind -n M-s selectw -t 3
bind -n M-t selectw -t 4
bind -n M-d selectw -t 5
bind -n M-h selectw -t 6

# popups
bind -n M-w run-shell "tmw >/dev/null || true" 
bind -n M-p popup -h 90% -w 90% -E lazygit

# Scratch window
set-hook -g session-created 'new-window -d -n scratch -t 100'
bind -n M-l selectw -T -t scratch

#----------------------------#
# Nvim integration for panes #
#----------------------------#

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?\.?(view|n?vim?x?)(-wrapped)?(diff)?$'"

bind-key -n 'M-n' if-shell "$is_vim" 'send-keys M-n' { if -F '#{pane_at_left}' '' 'select-pane -L' }
bind-key -n 'M-e' if-shell "$is_vim" 'send-keys M-e' { if -F '#{pane_at_top}' '' 'select-pane -U' }
bind-key -n 'M-i' if-shell "$is_vim" 'send-keys M-i' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind-key -n 'M-o' if-shell "$is_vim" 'send-keys M-o' { if -F '#{pane_at_right}' '' 'select-pane -R' }

bind-key -T copy-mode-vi 'M-n' select-pane -L
bind-key -T copy-mode-vi 'M-e' select-pane -U
bind-key -T copy-mode-vi 'M-i' select-pane -D
bind-key -T copy-mode-vi 'M-o' select-pane -R

bind -n 'M-C-n' if-shell "$is_vim" 'send-keys M-C-n' 'resize-pane -L 1'
bind -n 'M-C-e' if-shell "$is_vim" 'send-keys M-C-e' 'resize-pane -U 1'
bind -n 'M-C-i' if-shell "$is_vim" 'send-keys M-C-i' 'resize-pane -D 1'
bind -n 'M-C-o' if-shell "$is_vim" 'send-keys M-C-o' 'resize-pane -R 1'

bind-key -T copy-mode-vi M-n resize-pane -L 1
bind-key -T copy-mode-vi M-e resize-pane -U 1
bind-key -T copy-mode-vi M-i resize-pane -D 1
bind-key -T copy-mode-vi M-o resize-pane -R 1

bind -n 'S-M-n' if-shell "$is_vim" 'send-keys S-M-n' 'swap-pane -s "{left-of}"'
bind -n 'S-M-i' if-shell "$is_vim" 'send-keys S-M-i' 'swap-pane -s "{down-of}"'
bind -n 'S-M-e' if-shell "$is_vim" 'send-keys S-M-e' 'swap-pane -s "{up-of}"'
bind -n 'S-M-o' if-shell "$is_vim" 'send-keys S-M-o' 'swap-pane -s "{right-of}"'

bind-key -T copy-mode-vi S-M-n swap-pane -s "{left-of}"
bind-key -T copy-mode-vi S-M-i swap-pane -s "{down-of}"
bind-key -T copy-mode-vi S-M-e swap-pane -s "{up-of}"
bind-key -T copy-mode-vi S-M-o swap-pane -s "{right-of}"

#---------#
# Options #
#---------#

# Delete the session when the last window is closed
# set -g detach-on-destroy on

# Longer history
set -g history-limit 20000

set -g status-interval 1

set -g default-terminal "screen-256color"
set -g terminal-overrides ",xterm*:Tc"

set -g pane-border-style 'fg=colour7'
set -g pane-active-border-style 'fg=colour3'

# Mouse mode
set -g mouse on

# See https://unix.stackexchange.com/questions/608142/whats-the-effect-of-escape-time-in-tmux
# for this option, I'm not sure about how to explain it but nvim recommends it
set -g escape-time 10

# Another option recommended by nvim:
# > WARNING focus-events is not enabled. 'autoread' may not work.
set -g focus-events on

# Pass the window title to the terminal.
set-option -g set-titles on

#------------#
# Status bar #
#------------#

# Basic options
set -g status-justify absolute-centre
set -g status-bg colour0
set -g status-fg colour5
set -g status-left-length 70
set -g status-right-length 70
set -g status-position top # because vim is on the bottom

set -g status-left "#{@sis}#{T:@status-left-outer}#{@sos}#{T:@status-left-inner}#{@ses}"
set -g status-right "#{@sos}#{T:@status-right-inner}#{@sis}#{T:@status-right-outer}#{@ses}"

# Colors
set -g @sos "#[bg=#504945, fg=#ebdbb2, nobold]"
set -g @sis "#[bg=#a89984, fg=#282828, bold]"
set -g @ses ""

# Content
set -g @status-left-outer ' #{session_name} '
set -g @status-left-inner '#{?window_zoomed_flag,#[fg=colour0#,bg=colour3#,bold] ZOOMED, NORMAL} '

set -g @status-right-inner ' %H:%M '
set -g @status-right-outer ' #{user}@#{host_short} '

# Window title format
set -g set-titles-string "#{pane_title} "
set -g window-status-format "#[fg=colour0,bg=colour7] #I:#W "
set -g window-status-current-format "#[fg=colour0,bg=colour3] #I:#W "

